<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è –®–ø–∏–æ–Ω: –û–¥–Ω–∞ —Ç—Ä—É–±–∫–∞ –Ω–∞ –≤—Å–µ—Ö</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --spy: #f97316; --bg: #18181b; --card: #27272a; --text: #f4f4f5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 500px; padding: 20px; text-align: center; }
        .card { background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
        
        .btn { border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.2s; width: 100%; margin: 8px 0; font-family: inherit; font-size: 16px; }
        .btn-spy { background: var(--spy); color: white; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; }
        
        .role-viewer { height: 120px; display: flex; align-items: center; justify-content: center; background: var(--spy); border-radius: 15px; margin: 20px 0; font-size: 22px; font-weight: 900; cursor: pointer; user-select: none; border: 4px dashed rgba(255,255,255,0.3); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; }
        .item:active { background: var(--spy); }
        
        .hidden { display: none; }
        #timer { font-size: 50px; font-weight: 900; color: var(--spy); margin: 20px 0; }
        .step-info { color: #94a3b8; margin-bottom: 20px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--spy)">SPYFALL GAME</h1>

    <div id="sc-setup" class="card">
        <h3>–ù–æ–≤–∞—è –ø–∞—Ä—Ç–∏—è</h3>
        <p class="step-info">–ò–º–µ–Ω–∞ –ø–æ–¥—Ç—è–Ω—É—Ç—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
        <div id="player-list-preview" style="margin-bottom: 20px; opacity: 0.6"></div>
        <button class="btn btn-spy" onclick="prepareGame()">–ù–ê–ß–ê–¢–¨ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï</button>
    </div>

    <div id="sc-roles" class="card hidden">
        <h3 id="current-player-name">–ò–≥—Ä–æ–∫...</h3>
        <p class="step-info">–ó–∞–∂–º–∏ –æ—Ä–∞–Ω–∂–µ–≤—ã–π –±–ª–æ–∫, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–µ–∫—Ä–µ—Ç. <br>–û—Ç–ø—É—Å—Ç–∏ –∏ –ø–µ—Ä–µ–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω —Å–ª–µ–¥—É—é—â–µ–º—É.</p>
        <div class="role-viewer" onmousedown="showR()" onmouseup="hideR()" ontouchstart="showR()" ontouchend="hideR()">–£–î–ï–†–ñ–ò–í–ê–ô</div>
        <button id="btn-next-role" class="btn btn-outline hidden" onclick="nextP()">–°–õ–ï–î–£–Æ–©–ò–ô –ò–ì–†–û–ö</button>
    </div>

    <div id="sc-timer" class="card hidden">
        <div id="timer-val">05:00</div>
        <p>–û–±—Å—É–∂–¥–∞–π—Ç–µ! –ö—Ç–æ –≤–µ–¥–µ—Ç —Å–µ–±—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ?</p>
        <button class="btn btn-spy" onclick="startVoting()">–ö –ì–û–õ–û–°–û–í–ê–ù–ò–Æ</button>
    </div>

    <div id="sc-vote" class="card hidden">
        <h3 id="voter-name">–ö—Ç–æ –≥–æ–ª–æ—Å—É–µ—Ç?</h3>
        <p class="step-info">–ù–∞–∂–º–∏ –Ω–∞ —Ç–æ–≥–æ, –∫–æ–≥–æ —Å—á–∏—Ç–∞–µ—à—å —à–ø–∏–æ–Ω–æ–º. –¢–≤–æ–π –≤—ã–±–æ—Ä –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç.</p>
        <div id="vote-grid" class="grid"></div>
    </div>

    <div id="sc-results" class="card hidden">
        <h2 id="res-title">–ò—Ç–æ–≥–∏</h2>
        <div id="res-stats" style="margin: 20px 0; line-height: 1.6;"></div>
        <button class="btn btn-spy" onclick="saveAndExit()">–ó–ê–ü–ò–°–ê–¢–¨ –í –¢–ê–ë–õ–ò–¶–£ –ò –í–´–ô–¢–ò</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC77DjtldFSm-3VIWXQrHsCYL3hzjdUU-8",
        authDomain: "tabliz-baf06.firebaseapp.com",
        databaseURL: "https://tabliz-baf06-default-rtdb.firebaseio.com",
        projectId: "tabliz-baf06",
        storageBucket: "tabliz-baf06.firebasestorage.app",
        messagingSenderId: "42955040155",
        appId: "1:42955040155:web:f23b7cf6b27b6917c2ad3e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const locations = ["–ë–∞–Ω–∫", "–ö–∞–∑–∏–Ω–æ", "–¶–∏—Ä–∫ –®–∞–ø–∏—Ç–æ", "–û—Ä–±–∏—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è", "–ü–∏—Ä–∞—Ç—Å–∫–æ–µ —Å—É–¥–Ω–æ", "–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π —É—á–∞—Å—Ç–æ–∫", "–†–µ—Å—Ç–æ—Ä–∞–Ω", "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç"];
    
    let state = {
        players: [],
        spy: '',
        loc: '',
        idx: 0,
        votes: {}
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –±–∞–∑—ã
    db.ref('/spy/teams').once('value', (s) => {
        const teams = s.val() || [];
        state.players = teams.map(t => t.name);
        document.getElementById('player-list-preview').innerText = state.players.join(', ');
    });

    function prepareGame() {
        if(state.players.length < 3) return alert("–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é!");
        state.spy = state.players[Math.floor(Math.random() * state.players.length)];
        state.loc = locations[Math.floor(Math.random() * locations.length)];
        state.idx = 0;
        state.votes = {};
        showScreen('sc-roles');
        updateRoleView();
    }

    function updateRoleView() {
        document.getElementById('current-player-name').innerText = "–û—á–µ—Ä–µ–¥—å: " + state.players[state.idx];
        document.getElementById('btn-next-role').classList.add('hidden');
    }

    function showR() {
        const viewer = document.querySelector('.role-viewer');
        const p = state.players[state.idx];
        viewer.innerText = (p === state.spy) ? "–¢–´ –®–ü–ò–û–ù! üïµÔ∏è" : state.loc;
        viewer.style.background = "#ea580c";
        document.getElementById('btn-next-role').classList.remove('hidden');
    }

    function hideR() {
        document.querySelector('.role-viewer').innerText = "–£–î–ï–†–ñ–ò–í–ê–ô";
        document.querySelector('.role-viewer').style.background = "var(--spy)";
    }

    function nextP() {
        state.idx++;
        if(state.idx >= state.players.length) {
            showScreen('sc-timer');
            runTimer();
        } else {
            updateRoleView();
            hideR();
        }
    }

    function runTimer() {
        let t = 300;
        const el = document.getElementById('timer-val');
        const intrvl = setInterval(() => {
            let m = Math.floor(t / 60);
            let s = t % 60;
            el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if(t <= 0 || document.getElementById('sc-timer').classList.contains('hidden')) clearInterval(intrvl);
            t--;
        }, 1000);
    }

    function startVoting() {
        state.idx = 0;
        showScreen('sc-vote');
        updateVoteView();
    }

    function updateVoteView() {
        document.getElementById('voter-name').innerText = "–ì–æ–ª–æ—Å—É–µ—Ç: " + state.players[state.idx];
        const grid = document.getElementById('vote-grid');
        grid.innerHTML = state.players.map(p => `
            <div class="item" onclick="confirmVote('${p}')">${p}</div>
        `).join('');
    }

    function confirmVote(target) {
        state.votes[state.players[state.idx]] = target;
        state.idx++;
        if(state.idx >= state.players.length) {
            showResults();
        } else {
            alert("–í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç! –ü–µ—Ä–µ–¥–∞–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω: " + state.players[state.idx]);
            updateVoteView();
        }
    }

    function showResults() {
        showScreen('sc-results');
        const counts = {};
        Object.values(state.votes).forEach(v => counts[v] = (counts[v] || 0) + 1);

        let max = 0; let accused = "";
        for(let p in counts) { if(counts[p] > max) { max = counts[p]; accused = p; } }

        const win = (accused === state.spy);
        document.getElementById('res-title').innerText = win ? "–ü–û–ë–ï–î–ê –ñ–ò–¢–ï–õ–ï–ô!" : "–ü–û–ë–ï–î–ê –®–ü–ò–û–ù–ê!";
        
        let log = `<b>–®–ø–∏–æ–Ω–æ–º –±—ã–ª:</b> ${state.spy}<br><b>–ò–∑–≥–Ω–∞–ª–∏:</b> ${accused}<br><br><b>–ì–æ–ª–æ—Å–∞:</b><br>`;
        for(let v in state.votes) { log += `${v} ‚Üí ${state.votes[v]}<br>`; }
        
        document.getElementById('res-stats').innerHTML = log;
        state.finalRes = win ? 'lose' : 'win'; // 'lose' –¥–ª—è —à–ø–∏–æ–Ω–∞ = –ø–æ–±–µ–¥–∞ –∂–∏—Ç–µ–ª–µ–π
    }

    async function saveAndExit() {
        const snap = await db.ref('/spy/matches').get();
        let matches = snap.val() || [];
        matches.push({ spy: state.spy, res: state.finalRes, loc: state.loc, date: new Date().toLocaleString() });
        await db.ref('/spy/matches').set(matches);
        window.location.href = "index.html";
    }

    function showScreen(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
