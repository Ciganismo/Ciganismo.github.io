<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è –®–ø–∏–æ–Ω: Game Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --spy: #f97316; --bg: #18181b; --card: #27272a; --text: #f4f4f5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 500px; padding: 20px; text-align: center; }
        .card { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-spy { background: var(--spy); color: white; }
        .role-box { height: 140px; display: flex; align-items: center; justify-content: center; background: var(--spy); border-radius: 18px; margin: 20px 0; font-size: 24px; font-weight: 900; user-select: none; cursor: pointer; border: 3px dashed rgba(255,255,255,0.2); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .v-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color:var(--spy)">SPYFALL</h1>

    <div id="setup" class="card">
        <h3>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
        <p id="p-count">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...</p>
        <button class="btn btn-spy" onclick="start()">–†–ê–ó–î–ê–¢–¨ –†–û–õ–ò</button>
    </div>

    <div id="roles" class="card hidden">
        <h2 id="cur-name">–ò–≥—Ä–æ–∫</h2>
        <div class="role-box" onmousedown="showR()" onmouseup="hideR()" ontouchstart="showR()" ontouchend="hideR()">–ó–ê–ñ–ú–ò –ú–ï–ù–Ø</div>
        <button id="next-btn" class="btn hidden" style="background:#3f3f46; color:white" onclick="next()">–°–õ–ï–î–£–Æ–©–ò–ô</button>
    </div>

    <div id="vote" class="card hidden">
        <h3 id="voter-name">–ö—Ç–æ –≥–æ–ª–æ—Å—É–µ—Ç?</h3>
        <div id="vote-grid" class="grid"></div>
    </div>

    <div id="results" class="card hidden">
        <h2 id="res-title">–ò—Ç–æ–≥</h2>
        <div id="res-detail" style="margin-bottom:20px"></div>
        <button id="save-btn" class="btn btn-spy" onclick="saveAndExit()">–ó–ê–ü–ò–°–ê–¢–¨ –ò –í–´–ô–¢–ò</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC77DjtldFSm-3VIWXQrHsCYL3hzjdUU-8",
        authDomain: "tabliz-baf06.firebaseapp.com",
        databaseURL: "https://tabliz-baf06-default-rtdb.firebaseio.com",
        projectId: "tabliz-baf06",
        storageBucket: "tabliz-baf06.firebasestorage.app",
        messagingSenderId: "42955040155",
        appId: "1:42955040155:web:f23b7cf6b27b6917c2ad3e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const locs = ["–ë–∞–Ω–∫", "–û—Ç–µ–ª—å", "–¢–µ–∞—Ç—Ä", "–ü–æ–¥–≤–æ–¥–Ω–∞—è –ª–æ–¥–∫–∞", "–®–∫–æ–ª–∞", "–†–µ—Å—Ç–æ—Ä–∞–Ω", "–°–∞–º–æ–ª–µ—Ç"];
    let players = [];
    let game = { spy: '', loc: '', idx: 0, votes: {} };

    db.ref('/spy/teams').once('value', s => {
        players = (s.val() || []).map(t => t.name);
        document.getElementById('p-count').innerText = "–ò–≥—Ä–æ–∫–æ–≤: " + players.length;
    });

    function start() {
        if(players.length < 3) return alert("–ù—É–∂–Ω–æ 3+ –∏–≥—Ä–æ–∫–∞!");
        game.spy = players[Math.floor(Math.random()*players.length)];
        game.loc = locs[Math.floor(Math.random()*locs.length)];
        show('roles');
        updateR();
    }

    function updateR() {
        document.getElementById('cur-name').innerText = players[game.idx];
        document.getElementById('next-btn').classList.add('hidden');
    }

    function showR() {
        const b = document.querySelector('.role-box');
        b.innerText = players[game.idx] === game.spy ? "–¢–´ –®–ü–ò–û–ù! üïµÔ∏è" : game.loc;
        document.getElementById('next-btn').classList.remove('hidden');
    }

    function hideR() { document.querySelector('.role-box').innerText = "–ó–ê–ñ–ú–ò –ú–ï–ù–Ø"; }

    function next() {
        game.idx++;
        if(game.idx >= players.length) { game.idx = 0; show('vote'); updateV(); }
        else { updateR(); hideR(); }
    }

    function updateV() {
        document.getElementById('voter-name').innerText = "–ì–æ–ª–æ—Å—É–µ—Ç: " + players[game.idx];
        document.getElementById('vote-grid').innerHTML = players.map(p => `
            <div class="v-item" onclick="voteFor('${p}')">${p}</div>
        `).join('');
    }

    function voteFor(p) {
        game.votes[players[game.idx]] = p;
        game.idx++;
        if(game.idx >= players.length) finalize();
        else { alert("–ü—Ä–∏–Ω—è—Ç–æ! –ü–µ—Ä–µ–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω: " + players[game.idx]); updateV(); }
    }

    function finalize() {
        show('results');
        const counts = {};
        Object.values(game.votes).forEach(v => counts[v] = (counts[v] || 0) + 1);
        let max = 0, target = '';
        for(let p in counts) { if(counts[p] > max) { max = counts[p]; target = p; } }

        const isWin = (target === game.spy);
        document.getElementById('res-title').innerText = isWin ? "–ñ–ò–¢–ï–õ–ò –ü–û–ë–ï–î–ò–õ–ò!" : "–®–ü–ò–û–ù –ü–û–ë–ï–î–ò–õ!";
        document.getElementById('res-detail').innerHTML = `–®–ø–∏–æ–Ω–æ–º –±—ã–ª: <b>${game.spy}</b><br>–ò–∑–≥–Ω–∞–ª–∏: <b>${target}</b>`;
        game.result = isWin ? 'lose' : 'win'; 
    }

    async function saveAndExit() {
        const btn = document.getElementById('save-btn');
        btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        btn.disabled = true;

        try {
            const s = await db.ref('/spy/matches').get();
            let ms = s.val() || [];
            ms.push({ spy: game.spy, res: game.result, loc: game.loc, date: new Date().toISOString() });
            await db.ref('/spy/matches').set(ms);
            window.location.href = "index.html";
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ –±–∞–∑—ã!");
            btn.disabled = false;
            btn.innerText = "–ó–ê–ü–ò–°–ê–¢–¨ –ò –í–´–ô–¢–ò";
        }
    }

    function show(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
