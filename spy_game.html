<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è –®–ø–∏–æ–Ω: –ò–≥—Ä–æ–≤–æ–π –º–æ–¥—É–ª—å</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --spy: #f97316; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .container { width: 90%; max-width: 500px; padding: 20px; text-align: center; }
        .card { background: var(--card); padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        .btn { border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: 700; width: 100%; font-size: 16px; transition: 0.2s; margin-top: 10px; font-family: inherit; }
        .btn-spy { background: var(--spy); color: white; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .role-box { height: 160px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 20px; margin: 25px 0; font-size: 26px; font-weight: 900; user-select: none; cursor: pointer; border: 4px dashed rgba(255,255,255,0.3); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .v-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .v-item:active { background: var(--spy); transform: scale(0.95); }
        
        .hidden { display: none; }
        .status-bar { font-size: 12px; color: #94a3b8; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #timer { font-size: 54px; font-weight: 900; color: var(--spy); margin: 20px 0; font-variant-numeric: tabular-nums; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-bar">
        <span id="auth-status">–ö–æ–º–∞–Ω–¥–∞: –ù–µ –≤ —Å–µ—Ç–∏</span>
        <span id="player-count">–ò–≥—Ä–æ–∫–æ–≤: 0</span>
    </div>

    <div id="sc-setup" class="card">
        <h1 style="color:var(--spy); margin-top:0">SPYFALL</h1>
        <p>–î–ª—è –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü—É –Ω—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã.</p>
        <button id="login-btn" class="btn btn-outline" onclick="handleAuth()">üîê –í–æ–π—Ç–∏ (Google)</button>
        <hr style="margin: 20px 0; opacity: 0.1">
        <button class="btn btn-spy" onclick="startGame()">–ù–ê–ß–ê–¢–¨ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï</button>
        <button class="btn btn-outline" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <div id="sc-roles" class="card hidden">
        <h2 id="cur-player">–ò–≥—Ä–æ–∫...</h2>
        <p style="opacity: 0.7; font-size: 14px">–ó–∞–∂–º–∏ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π –±–ª–æ–∫, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ä–æ–ª—å. –û—Ç–ø—É—Å—Ç–∏ –∏ –ø–µ—Ä–µ–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω.</p>
        <div class="role-box" onmousedown="showRole()" onmouseup="hideRole()" ontouchstart="showRole()" ontouchend="hideRole()">–£–î–ï–†–ñ–ò–í–ê–¢–¨</div>
        <button id="btn-next-p" class="btn btn-spy hidden" onclick="nextPlayer()">–°–õ–ï–î–£–Æ–©–ò–ô –ò–ì–†–û–ö</button>
    </div>

    <div id="sc-timer" class="card hidden">
        <h3>–û–±—Å—É–∂–¥–µ–Ω–∏–µ</h3>
        <div id="timer">05:00</div>
        <button class="btn btn-spy" onclick="goToVote()">–ö –ì–û–õ–û–°–û–í–ê–ù–ò–Æ</button>
    </div>

    <div id="sc-vote" class="card hidden">
        <h3 id="voter-name">–ì–æ–ª–æ—Å—É–µ—Ç: ...</h3>
        <p style="opacity:0.7; font-size:13px">–¢–≤–æ–π –≤—ã–±–æ—Ä –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –æ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.</p>
        <div id="vote-grid" class="grid"></div>
    </div>

    <div id="sc-results" class="card hidden">
        <h1 id="res-title" style="margin-top:0">–ò–¢–û–ì–ò</h1>
        <div id="res-body" style="margin-bottom: 25px; line-height: 1.6;"></div>
        <button id="save-btn" class="btn btn-spy" onclick="saveToFirebase()">–ó–ê–ü–ò–°–ê–¢–¨ –í –¢–ê–ë–õ–ò–¶–£</button>
        <button class="btn btn-outline" onclick="window.location.href='index.html'">–í–´–ô–¢–ò –ë–ï–ó –ó–ê–ü–ò–°–ò</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC77DjtldFSm-3VIWXQrHsCYL3hzjdUU-8",
        authDomain: "tabliz-baf06.firebaseapp.com",
        databaseURL: "https://tabliz-baf06-default-rtdb.firebaseio.com",
        projectId: "tabliz-baf06",
        appId: "1:42955040155:web:f23b7cf6b27b6917c2ad3e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const locations = ["–ë–∞–Ω–∫", "–û—Ç–µ–ª—å", "–ö–∞–∑–∏–Ω–æ", "–°–∞–º–æ–ª–µ—Ç", "–¶–∏—Ä–∫", "–ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å", "–ü–æ–ª—è—Ä–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è", "–õ—É–Ω–∞", "–î–∂—É–Ω–≥–ª–∏"];
    let state = {
        players: [],
        spy: '',
        loc: '',
        idx: 0,
        votes: {},
        finalRes: ''
    };

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    auth.onAuthStateChanged(user => {
        const status = document.getElementById('auth-status');
        const loginBtn = document.getElementById('login-btn');
        if (user) {
            status.innerText = "–ö–æ–º–∞–Ω–¥–∞: " + user.displayName;
            status.style.color = "#10b981";
            loginBtn.innerText = "–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞";
        } else {
            status.innerText = "–ö–æ–º–∞–Ω–¥–∞: –ù–µ –≤ —Å–µ—Ç–∏";
            status.style.color = "#ef4444";
            loginBtn.innerText = "üîê –í–æ–π—Ç–∏ (Google)";
        }
    });

    async function handleAuth() {
        if(auth.currentUser) await auth.signOut();
        else await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    }

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    db.ref('/spy/teams').once('value', s => {
        state.players = (s.val() || []).map(t => t.name);
        document.getElementById('player-count').innerText = "–ò–≥—Ä–æ–∫–æ–≤: " + state.players.length;
    });

    // 3. –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π
    function startGame() {
        if(state.players.length < 3) return alert("–ú–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤! –î–æ–±–∞–≤—å –∏—Ö –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.");
        state.spy = state.players[Math.floor(Math.random() * state.players.length)];
        state.loc = locations[Math.floor(Math.random() * locations.length)];
        state.idx = 0;
        switchScreen('sc-roles');
        updateRoleScreen();
    }

    function updateRoleScreen() {
        document.getElementById('cur-player').innerText = "–û—á–µ—Ä–µ–¥—å: " + state.players[state.idx];
        document.getElementById('btn-next-p').classList.add('hidden');
    }

    function showRole() {
        const box = document.querySelector('.role-box');
        const p = state.players[state.idx];
        box.innerText = (p === state.spy) ? "–¢–´ –®–ü–ò–û–ù! üïµÔ∏è" : state.loc;
        box.style.background = "#ea580c";
        document.getElementById('btn-next-p').classList.remove('hidden');
    }

    function hideRole() {
        const box = document.querySelector('.role-box');
        box.innerText = "–£–î–ï–†–ñ–ò–í–ê–¢–¨";
        box.style.background = "linear-gradient(135deg, #f97316, #ea580c)";
    }

    function nextPlayer() {
        state.idx++;
        if(state.idx >= state.players.length) {
            switchScreen('sc-timer');
            startTimer(300);
        } else {
            updateRoleScreen();
            hideRole();
        }
    }

    // 4. –¢–∞–π–º–µ—Ä
    function startTimer(sec) {
        const el = document.getElementById('timer');
        const interval = setInterval(() => {
            let m = Math.floor(sec / 60);
            let s = sec % 60;
            el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (sec <= 0 || document.getElementById('sc-timer').classList.contains('hidden')) clearInterval(interval);
            sec--;
        }, 1000);
    }

    // 5. –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
    function goToVote() {
        state.idx = 0;
        state.votes = {};
        switchScreen('sc-vote');
        updateVoteScreen();
    }

    function updateVoteScreen() {
        document.getElementById('voter-name').innerText = "–ì–æ–ª–æ—Å—É–µ—Ç: " + state.players[state.idx];
        const grid = document.getElementById('vote-grid');
        grid.innerHTML = state.players.map(p => `
            <div class="v-item" onclick="confirmVote('${p}')">${p}</div>
        `).join('');
    }

    function confirmVote(target) {
        state.votes[state.players[state.idx]] = target;
        state.idx++;
        if(state.idx >= state.players.length) {
            calculateResults();
        } else {
            alert("–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç. –ü–µ—Ä–µ–¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–≥—Ä–æ–∫—É: " + state.players[state.idx]);
            updateVoteScreen();
        }
    }

    // 6. –ò—Ç–æ–≥–∏
    function calculateResults() {
        switchScreen('sc-results');
        const counts = {};
        Object.values(state.votes).forEach(v => counts[v] = (counts[v] || 0) + 1);
        
        let max = 0; let accused = "–ù–∏–∫—Ç–æ";
        for(let p in counts) { if(counts[p] > max) { max = counts[p]; accused = p; } }

        const win = (accused === state.spy);
        state.finalRes = win ? 'lose' : 'win'; // —à–ø–∏–æ–Ω 'lose' = –∂–∏—Ç–µ–ª–∏ –ø–æ–±–µ–¥–∏–ª–∏

        document.getElementById('res-title').innerText = win ? "–ñ–ò–¢–ï–õ–ò –ü–û–ë–ï–î–ò–õ–ò! üèÜ" : "–®–ü–ò–û–ù –ü–û–ë–ï–î–ò–õ! üïµÔ∏è";
        let log = `<b>–®–ø–∏–æ–Ω–æ–º –±—ã–ª:</b> ${state.spy}<br><b>–õ–æ–∫–∞—Ü–∏—è:</b> ${state.loc}<br><br><b>–ò–∑–≥–Ω–∞–ª–∏:</b> ${accused}<br><br><b>–ì–æ–ª–æ—Å–∞:</b><br>`;
        for(let v in state.votes) log += `<small>${v} ‚Üí ${state.votes[v]}</small><br>`;
        document.getElementById('res-body').innerHTML = log;
    }

    // 7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–° –ü–†–û–í–ï–†–ö–û–ô –ü–†–ê–í)
    async function saveToFirebase() {
        if(!auth.currentUser) {
            alert("–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.");
            return;
        }

        const btn = document.getElementById('save-btn');
        btn.innerText = "–°–û–•–†–ê–ù–Ø–ï–ú...";
        btn.disabled = true;

        try {
            const snap = await db.ref('/spy/matches').get();
            let matches = snap.val() || [];
            matches.push({
                spy: state.spy,
                res: state.finalRes,
                loc: state.loc,
                date: new Date().toISOString()
            });
            await db.ref('/spy/matches').set(matches);
            window.location.href = "index.html";
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏! –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ Firebase (Rules).");
            btn.disabled = false;
            btn.innerText = "–ó–ê–ü–ò–°–ê–¢–¨ –í –¢–ê–ë–õ–ò–¶–£";
        }
    }

    function switchScreen(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
