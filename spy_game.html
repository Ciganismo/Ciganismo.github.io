<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïµÔ∏è –®–ø–∏–æ–Ω: –ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --spy: #f97316; --bg: #18181b; --card: #27272a; --text: #f4f4f5; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 500px; padding: 20px; text-align: center; }
        .card { background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
        
        .btn { border: none; padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; transition: 0.2s; width: 100%; margin: 5px 0; font-family: inherit; }
        .btn-spy { background: var(--spy); color: white; }
        .btn-outline { background: rgba(255,255,255,0.1); color: white; }
        
        .role-box { height: 100px; display: flex; align-items: center; justify-content: center; background: var(--spy); border-radius: 15px; margin: 20px 0; font-size: 24px; font-weight: 900; cursor: pointer; user-select: none; }
        
        .vote-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .vote-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; }
        .vote-item.selected { border-color: var(--spy); background: rgba(249, 115, 22, 0.1); }
        
        .hidden { display: none; }
        #timer { font-size: 48px; font-weight: 900; color: var(--spy); margin: 20px 0; }
        .voted-count { font-size: 12px; color: #94a3b8; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--spy)">SPYFALL 2.0</h1>

    <div id="screen-setup" class="card">
        <p>–ò–≥—Ä–æ–∫–∏ –ø–æ–¥—Ç—è–Ω—É—Ç—ã –∏–∑ –±–∞–∑—ã. –ù–∞—á–Ω–∏ –∏–≥—Ä—É, —á—Ç–æ–±—ã —Ä–∞–∑–¥–∞—Ç—å —Ä–æ–ª–∏.</p>
        <div id="players-preview" style="margin-bottom: 20px; font-size: 14px; opacity: 0.7;"></div>
        <button class="btn btn-spy" onclick="serverStart()">–ù–ê–ß–ê–¢–¨ –ù–û–í–£–Æ –ò–ì–†–£</button>
    </div>

    <div id="screen-roles" class="card hidden">
        <h3>–í–∞—à–∞ —Ä–æ–ª—å</h3>
        <p>–ó–∞–∂–º–∏ –±–ª–æ–∫ –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–µ–∫—Ä–µ—Ç</p>
        <div class="role-box" onmousedown="showRole()" onmouseup="hideRole()" ontouchstart="showRole()" ontouchend="hideRole()">–£–î–ï–†–ñ–ò–í–ê–¢–¨</div>
        <p id="role-player-name" style="opacity: 0.5"></p>
        <button class="btn btn-outline" onclick="goToTimer()">–í–°–ï –£–í–ò–î–ï–õ–ò –†–û–õ–ò ‚Üí</button>
    </div>

    <div id="screen-timer" class="card hidden">
        <div id="timer">05:00</div>
        <button class="btn btn-spy" onclick="serverStartVote()">–ü–ï–†–ï–ô–¢–ò –ö –ì–û–õ–û–°–û–í–ê–ù–ò–Æ</button>
    </div>

    <div id="screen-vote" class="card hidden">
        <h3>–ö–¢–û –®–ü–ò–û–ù?</h3>
        <p>–ì–æ–ª–æ—Å—É–π –∞–Ω–æ–Ω–∏–º–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ.</p>
        <div id="vote-options" class="vote-grid"></div>
        <div id="vote-status" class="voted-count">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: 0 / 0</div>
    </div>

    <div id="screen-results" class="card hidden">
        <h2 id="result-title">–ò—Ç–æ–≥–∏</h2>
        <p id="result-desc"></p>
        <button class="btn btn-spy" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC77DjtldFSm-3VIWXQrHsCYL3hzjdUU-8",
        authDomain: "tabliz-baf06.firebaseapp.com",
        databaseURL: "https://tabliz-baf06-default-rtdb.firebaseio.com",
        projectId: "tabliz-baf06",
        storageBucket: "tabliz-baf06.firebasestorage.app",
        messagingSenderId: "42955040155",
        appId: "1:42955040155:web:f23b7cf6b27b6917c2ad3e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myName = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è (–∫–∞–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ):") || "–ì–æ—Å—Ç—å";
    let gameState = {};
    const locations = ["–ë–∞–Ω–∫", "–ö–∞–∑–∏–Ω–æ", "–ü–æ–ª—è—Ä–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è", "–û—Ç–µ–ª—å", "–°–∞–º–æ–ª–µ—Ç", "–ü–∏—Ä–∞—Ç—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å"];

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    db.ref('/spy/active_game').on('value', (snap) => {
        gameState = snap.val();
        if (!gameState) return;
        renderScreen();
    });

    function serverStart() {
        db.ref('/spy/teams').once('value', (snap) => {
            const teams = snap.val() || [];
            const playerNames = teams.map(t => t.name);
            if(playerNames.length < 3) return alert("–ú–∞–ª–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –±–∞–∑–µ!");

            const spy = playerNames[Math.floor(Math.random() * playerNames.length)];
            const loc = locations[Math.floor(Math.random() * locations.length)];

            db.ref('/spy/active_game').set({
                phase: 'roles',
                players: playerNames,
                spy: spy,
                location: loc,
                votes: {},
                startTime: Date.now()
            });
        });
    }

    function renderScreen() {
        // –ü—Ä—è—á–µ–º –≤—Å–µ
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        
        if (gameState.phase === 'roles') {
            document.getElementById('screen-roles').classList.remove('hidden');
            document.getElementById('role-player-name').innerText = "–ò–≥—Ä–æ–∫: " + myName;
        } else if (gameState.phase === 'timer') {
            document.getElementById('screen-timer').classList.remove('hidden');
            updateTimerDisplay();
        } else if (gameState.phase === 'vote') {
            document.getElementById('screen-vote').classList.remove('hidden');
            renderVoteOptions();
        } else if (gameState.phase === 'results') {
            document.getElementById('screen-results').classList.remove('hidden');
            showFinalResults();
        }
    }

    function showRole() {
        const box = document.querySelector('.role-box');
        box.innerText = (myName === gameState.spy) ? "–¢–´ –®–ü–ò–û–ù! üïµÔ∏è" : gameState.location;
    }

    function hideRole() {
        document.querySelector('.role-box').innerText = "–£–î–ï–†–ñ–ò–í–ê–¢–¨";
    }

    function goToTimer() {
        db.ref('/spy/active_game/phase').set('timer');
    }

    function serverStartVote() {
        db.ref('/spy/active_game/phase').set('vote');
    }

    function renderVoteOptions() {
        const container = document.getElementById('vote-options');
        const votedCount = gameState.votes ? Object.keys(gameState.votes).length : 0;
        document.getElementById('vote-status').innerText = `–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ: ${votedCount} / ${gameState.players.length}`;

        if (gameState.votes && gameState.votes[myName]) {
            container.innerHTML = "<p>–í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç. –ñ–¥–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö...</p>";
            if (votedCount >= gameState.players.length) {
                db.ref('/spy/active_game/phase').set('results');
            }
            return;
        }

        container.innerHTML = gameState.players.map(p => 
            `<div class="vote-item" onclick="castVote('${p}')">${p}</div>`
        ).join('');
    }

    async function castVote(target) {
        await db.ref(`/spy/active_game/votes/${myName}`).set(target);
    }

    function showFinalResults() {
        const votes = gameState.votes || {};
        const counts = {};
        Object.values(votes).forEach(v => counts[v] = (counts[v] || 0) + 1);

        let maxVotes = 0;
        let accused = "–ù–∏–∫—Ç–æ";
        for (let p in counts) {
            if (counts[p] > maxVotes) { maxVotes = counts[p]; accused = p; }
        }

        const isSuccess = (accused === gameState.spy);
        document.getElementById('result-title').innerText = isSuccess ? "–®–ü–ò–û–ù –ü–û–ô–ú–ê–ù!" : "–®–ü–ò–û–ù –ü–û–ë–ï–î–ò–õ!";
        document.getElementById('result-desc').innerText = `–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–æ –∑–∞ ${accused}. –®–ø–∏–æ–Ω–æ–º –±—ã–ª: ${gameState.spy}`;

        // –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ (–∞–¥–º–∏–Ω) –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if (myName === gameState.players[0]) {
            saveToStats(isSuccess ? 'lose' : 'win');
        }
    }

    async function saveToStats(res) {
        const snap = await db.ref('/spy/matches').get();
        let matches = snap.val() || [];
        if (matches.length > 0 && matches[matches.length-1].time === gameState.startTime) return; 

        matches.push({ spy: gameState.spy, res: res, loc: gameState.location, time: gameState.startTime });
        await db.ref('/spy/matches').set(matches);
    }

    function updateTimerDisplay() {
        // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
        document.getElementById('timer').innerText = "–ò–î–ï–¢ –û–ë–°–£–ñ–î–ï–ù–ò–ï";
    }
</script>
</body>
</html>
